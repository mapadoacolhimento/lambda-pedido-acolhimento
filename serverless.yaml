service: support-request-api

frameworkVersion: "3.40.0"
useDotenv: true

package:
  patterns:
    - '!node_modules/.prisma/client/libquery_engine-*'
    - 'node_modules/.prisma/client/libquery_engine-rhel-*'
    - '!node_modules/prisma/libquery_engine-*'
    - '!node_modules/@prisma/engines/**'

custom:
  webpack:
    webpackConfig: 'webpack.config.js'
    includeModules:
      forceExclude:
        - aws-sdk
        - '@types/*' # Exclui tipos TypeScript
        - 'jest*'    # Exclui Jest
        - 'eslint*'  # Exclui ESLint
        - 'prettier' # Exclui Prettier
        - 'husky'    # Exclui Husky
        - 'lint-staged' # Exclui lint-staged
        - 'webpack'  # Webpack não vai para Lambda
        - 'serverless*' # Serverless não vai para Lambda
      nodeModulesRelativeDir: '../../'

    excludeFiles: '**/*.test.ts'
    packagerOptions:
      scripts:
        - npx prisma generate
        - find . -name "libquery_engine-*" -not -name "libquery_engine-rhel-openssl-*" | xargs rm
  serverless-offline:
    httpPort: 5000
    ignoreJWTSignature: true
  newRelic:
    accountId: ${env:NEW_RELIC_ACCOUNT_ID}
    apiKey: ${env:NEW_RELIC_API_KEY}
    cloudWatchFilter: "*"
    nrRegion: 'eu'
    enableFunctionLogs: true
   # Bundle individualmente para cada função
  individually: true
  
  # Excluir arquivos desnecessários
  exclude:
    - .git/**
    - .github/**
    - .vscode/**
    - node_modules/.cache/**
    - node_modules/.bin/**
    - node_modules/**/test/**
    - node_modules/**/tests/**
    - node_modules/**/docs/**
    - node_modules/**/*.md
    - coverage/**
    - dist/**
    - '*.log'
    
  prune:
    automatic: true
    number: 3
provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:AWS_REGION}
  httpApi:
    metrics: true
    cors: true
    authorizers:
      auth:
        type: request
        functionName: auth
        identitySource: $request.header.Authorization
  environment:
    JWT_SECRET: ${env:JWT_SECRET}
    DATABASE_URL: ${env:DATABASE_URL}
    ZENDESK_SUBDOMAIN: ${env:ZENDESK_SUBDOMAIN}
    ZENDESK_API_USER: ${env:ZENDESK_API_USER}
    ZENDESK_API_TOKEN: ${env:ZENDESK_API_TOKEN}
    LOOPS_API_KEY: ${env:LOOPS_API_KEY}

functions:
  auth:
    handler: handler.auth

  compose:
    handler: handler.compose
    timeout: 30 # max timeout for api gateway
    events:
      - httpApi:
          path: /compose
          method: POST
          authorizer:
            name: auth
            type: request

  sign:
    handler: handler.sign
    events:
      - httpApi:
          path: /sign
          method: GET

  manualMatch:
    handler: handler.manualMatch
    timeout: 30
    events:
      - httpApi:
          path: /manual-match
          method: POST

  handleMatch:
    handler: handler.handleMatch
    timeout: 30
    events:
      - httpApi:
          path: /handle-match
          method: POST
          authorizer:
            name: auth
            type: request

  createMatch:
    handler: handler.createNewMatch
    timeout: 30
    events:
      - httpApi:
          path: /create-match
          method: POST
          authorizer:
            name: auth
            type: request

  findVolunteer:
    handler: handler.findVolunteer
    timeout: 30
    events:
      - httpApi:
          path: /find-volunteer
          method: POST
          authorizer:
            name: auth
            type: request

  feature-flag:
    handler: handler.featureFlag
    events:
      - httpApi:
          path: /feature-flag
          method: GET
          authorizer:
            name: auth
            type: request

plugins:
  - serverless-webpack
  - serverless-offline
  - serverless-newrelic-lambda-layers
